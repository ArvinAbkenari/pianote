{% extends 'base.html' %}
{% load static %}
{% block title %}نت کده - پیانوت{% endblock %}
{% load star_tags %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'notes/sheets.css' %}">
{% endblock %}
{% load humanize %}
{% block content %}
    <!-- Main Content -->
    <div class="sheets-container">
        <div class="container">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-3">
                    <div class="sidebar">
                        <h3 class="sidebar-title">فیلتر ها</h3>
                        
                        <form action="/notes/" method="get" id="filterForm">
                            <div class="filter-header d-flex justify-content-between align-items-center mb-3">
                            <button type="submit" id="filterButton" class="btn btn-primary">اعمال فیلتر</button>
                            <button type="button" class="btn btn-outline-danger" onclick="resetFilters()">حذف فیلتر</button>
                            </div>
                            <div class="filter-section">
                                <h4>سبک موسیقی</h4>
                                <ul class="filter-list">
                                    <li><label><input type="checkbox" name="genre" value="Classical" {% if 'Classical' in selected_genres %}checked{% endif %}> کلاسیک</label></li>
                                    <li><label><input type="checkbox" name="genre" value="Jazz" {% if 'Jazz' in selected_genres %}checked{% endif %}> جاز</label></li>
                                    <li><label><input type="checkbox" name="genre" value="pop" {% if 'pop' in selected_genres %}checked{% endif %}> پاپ</label></li>
                                    <li><label><input type="checkbox" name="genre" value="traditional" {% if 'traditional' in selected_genres %}checked{% endif %}> سنتی</label></li>
                                </ul>
                            </div>
                            <div class="filter-section">
                                <h4>سطح دشواری</h4>
                                <ul class="filter-list">
                                    <li><label><input type="checkbox" name="level" value="1" {% if '1' in selected_levels %}checked{% endif %}> مبتدی</label></li>
                                    <li><label><input type="checkbox" name="level" value="2" {% if '2' in selected_levels %}checked{% endif %}> متوسط</label></li>
                                    <li><label><input type="checkbox" name="level" value="3" {% if '3' in selected_levels %}checked{% endif %}> پیشرفته</label></li>
                                </ul>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Sheet Music Grid -->
                <div class="col-lg-9">
                    <div class="input-with-icon">
                        <input type="text" id="searchInput" class="form-control search-bar" placeholder="جستجو در نت‌ها..." onkeyup="debounceSearch()">
                        <i class="icon bi bi-search"></i>

                    </div>
                    <div id="results" class="search-results mt-2 mb-4">

                    </div>
                    <div class="sheets-grid">
                        <div class="row g-4">
                            <!-- Sheet Music Items -->
                            {% for note in notes %}
                            <div class="col-md-6 col-lg-4">
                                <a href="{% url 'note-detail' note.id %}">

                                    <div class="sheet-card">
                                        <img src="{{ note.notesheet.url }}" alt="نت موسیقی" class="sheet-preview">
                                        <div class="sheet-info">
                                            <h3>{{ note.name }}</h3>
                                            <p class="composer">{{note.composer}}</p>
                                            <div class="d-flex ">
                                                <div class="sheet-rating mb-2">
                                                    {% for i in "12345" %}
                                                        {% with note.rate|star_class:forloop.counter as star_class %}
                                                            <i class="icon bi {{ star_class }}"
                                                               {% if star_class == "bi-star-half" %}
                                                                   style="transform: scaleX(-1); display: inline-block;"
                                                               {% endif %}>
                                                            </i>
                                                        {% endwith %}
                                                    {% endfor %}
                                                </div>
                                                <p class="mx-2 opacity-50">|</p>
                                                <div class="view_count">
                                                    <span class="views">{{ note.views|intcomma|to_persian_digits }}</span>
                                                    <i class="bi bi-eye-fill"></i>
                                                </div>
                                            </div>
                                            <div class="sheet-meta">
                                                <a href="/notes/?level={{ note.level }}" class="difficulty">{{ note.level_value }}</a>
                                                {%for genre in note.genre%}
                                                    <span class="genre" onclick="searchByGenre('{{ genre }}')">{{genre}}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                             {% endfor %}
                        </div>
                        <!-- Pagination -->
                        <nav class="mt-5" aria-label="صفحه بندی">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}" tabindex="-1">قبلی</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">قبلی</a>
                                    </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active" aria-current="page">
                                            <a class="page-link" href="#">{{ num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">بعدی</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-disabled="true">بعدی</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function searchArticles() {
            const query = document.getElementById("searchInput").value;
        
            if (!query.trim()) {
                document.getElementById("results").innerHTML = "";
                return;
            }
        
            fetch(`/ajax/search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then (data => {
                    const resultsDiv = document.getElementById("results");
                    resultsDiv.innerHTML = "";
        
                    if (data.results.length === 0) {
                        resultsDiv.innerHTML = "<p>نتیجه‌ای یافت نشد.</p>";
                        return;
                    }
        
                    data.results.forEach(item => {
                        // Modern card style for each result
                        const div = document.createElement("div");
                        div.className = "search-result-card";
                        div.innerHTML = `
                            <a href="/notes/${item.id}/" class="result-link">
                                <div class="d-flex align-items-center">
                                    <div>
                                        <strong class="result-title">${item.name}</strong><br>
                                        <span class="result-composer">${item.composer ? item.composer : ''}</span>
                                    </div>
                                </div>
                            </a>
                        `;
                        resultsDiv.appendChild(div);
                    });
                });
        }
        
        // Debounce for smoother UX
        let debounceTimeout;
        function debounceSearch() {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(searchArticles, 300);
        }

        function searchByDifficulty(level) {
            const query = `level=${encodeURIComponent(level)}`;
            window.location.href = `/notes/?${query}`;
        }

        function searchByGenre(genre) {
            const query = `genre=${encodeURIComponent(genre)}`;
            window.location.href = `/notes/?${query}`;
        }

        function resetFilters() {
            window.location.href = '/notes/';
        }
    </script>
    {% endblock %}
    <!-- Footer -->
