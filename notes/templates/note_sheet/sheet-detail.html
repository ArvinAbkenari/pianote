{% extends 'base.html' %} {% load static %} {% load humanize %} {% load star_tags %} {% block title %}نت کده - پیانوت{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'note_sheet/sheet-detail.css' %}" />
{% endblock %} {% block content %}

<!-- Main Content -->
<div class="sheet-detail-container">
  <div class="container">
    <div class="row my-3 g-5">
      <div class="col-lg-6">
        <!-- Hero Section -->
        <section class="sheet-hero pt-4 pb-1">
          <h1 class="sheet-title">{{ note.name }}</h1>
          <div class="composer mb-3">
            <span>آهنگساز:</span>
            <span class="composer-name">{{ note.composer }}</span>
          </div>
          <div class="metadata d-flex flex-wrap gap-3 mb-4">
            <span class="badge bg-primary">{{ note.genre|join:", " }}</span>
            <span class="badge bg-info">{{ note.level_value }}</span>
            <div class="views">
              <i class="bi bi-eye"></i>
              <span>{{ note.views|intcomma|to_persian_digits }} بازدید</span>
            </div>
            <div class="d-flex align-items-center">
              <div class="rating ms-2">
                {% for i in "12345" %}
                  {% with note.rate|star_class:forloop.counter as star_class %}
                    <i class="bi {{ star_class }} text-warning"></i>
                  {% endwith %}
                {% endfor %}
                <span>({{ note.rate }})</span>
              </div>
              {% if request.session.user_id %}
                <form method="post" name="voting" style="display:inline; margin-left: 0.5rem; margin-right: 0.5rem;">
                  <input type="hidden" name="form_type" value="voting">
                  {% csrf_token %}
                  <input type="hidden" name="vote" value="like" id="like-vote-input">
                  <input type="hidden" name="vote" value="dislike" id="dislike-vote-input">
                  <span class="vote-icon like-icon {% if my_vote == 'like' %}active{% endif %}" style="font-size:1.3rem; cursor:pointer; vertical-align:middle;">
                    <i class="bi {% if my_vote == 'like' %}bi-hand-thumbs-up-fill{% else %}bi-hand-thumbs-up{% endif %}" ></i>
                  </span>
                  <span class="vote-icon dislike-icon ms-2 {% if my_vote == 'dislike' %}active{% endif %}" style="font-size:1.3rem; cursor:pointer; vertical-align:middle;">
                    <i class="bi {% if my_vote == 'dislike' %}bi-hand-thumbs-down-fill{% else %}bi-hand-thumbs-down{% endif %}" ></i>
                  </span>
                </form>
                <style>
                  .vote-icon:hover i {
                    filter: brightness(1.3);
                    transform: scale(1.1);
                    transition: 0.15s;
                  }
                  .vote-icon.active i {
                    filter: none;
                    transform: scale(1.15);
                  }
                </style>
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    var likeIcon = document.querySelector('.like-icon');
                    var dislikeIcon = document.querySelector('.dislike-icon');
                    var form = document.getElementsByName('voting')[0];
                    if (likeIcon) {
                      likeIcon.addEventListener('click', function() {
                        form.querySelector('#like-vote-input').disabled = false;
                        form.querySelector('#dislike-vote-input').disabled = true;
                        form.querySelector('#like-vote-input').setAttribute('name', 'vote');
                        form.querySelector('#dislike-vote-input').removeAttribute('name');
                        form.submit();
                      });
                    }
                    if (dislikeIcon) {
                      dislikeIcon.addEventListener('click', function() {
                        form.querySelector('#dislike-vote-input').disabled = false;
                        form.querySelector('#like-vote-input').disabled = true;
                        form.querySelector('#dislike-vote-input').setAttribute('name', 'vote');
                        form.querySelector('#like-vote-input').removeAttribute('name');
                        form.submit();
                      });
                    }
                  });
                </script>
              {% endif %}
            </div>
          </div>
        </section>

        <!-- Description Section -->
        <section class="sheet-description mb-5">
          <h2>درباره این قطعه</h2>
          <p>
            {{ note.description }}
          </p>
        </section>

        <!-- Audio Player Section -->
        <section class="audio-player mb-5">
          <h2>پیش نمایش صوتی</h2>
          <div class="player-wrapper p-3 rounded">
            <audio controls class="w-100">
              <source src="{% static "images/sample.mp3" %}" type="audio/mp3" />
              مرورگر شما از پخش صوتی پشتیبانی نمی‌کند.
            </audio>
          </div>
        </section>

        <!-- Comments Section -->
        <section class="comments-section">
          <h2>نظرات کاربران</h2>
          <div class="comments-list">
            {% for comment in comments %}
            <div class="comment p-3 mb-3 rounded">
              <div class="d-flex justify-content-between">
                <h5 class="comment-author">{{ comment.fullName }}</h5>
                <small>{{ comment.createdAt|persian_timesince }}</small>
              </div>
              <p class="mb-0">
                {{ comment.text }}
              </p>
            </div>
            {% empty %}
            <p>هنوز نظری ثبت نشده است.</p>
            {% endfor %}
          </div>
          {% if request.session.user_id %}
          <form method="post" class="comment-form mb-4" name = 'comment'>
            <input type="hidden" name="form_type" value="comment">
            {% csrf_token %}
            <textarea
              class="form-control mb-3"
              rows="3"
              name="comment_text"
              placeholder="نظر خود را بنویسید..."
              required
            ></textarea>
            <button type="submit" class="btn btn-primary">ارسال نظر</button>
          </form>
          {% else %}
          <div class="alert alert-warning mt-3">برای ثبت نظر باید وارد شوید.</div>
          {% endif %}
        </section>
      </div>

      <div class="col-lg-6">
        <div class="position-sticky" style="top: 2rem">
          <!-- Sheet Image -->
          <div class="mb-4">
            <!-- <img src="../assets/notes.jpg" alt="سونات مهتاب" class="img-fluid rounded shadow"> -->
            <!-- <embed class="pdf-viewer" src="../assets/sheet.pdf" width="100%" height="600px" type="application/pdf"> -->
            <div id="pdf-viewer"></div>
          </div>

          <!-- Download Box -->
          <div class="download-box p-4 rounded mb-4">
            <h3>دانلود نت</h3>
            <div class="file-info mb-3">
              <p class="mb-2">
                <i class="bi bi-file-earmark-pdf"></i>
                فرمت: PDF
              </p>
              <p class="mb-2">
                <i class="bi bi-file-text"></i>
                تعداد صفحات: {% if pdf_page_count %}{{ pdf_page_count|to_persian_digits }}{% else %}نامشخص{% endif %}
              </p>
            </div>
            <a href='{{note.notesheet.url}}' class="btn btn-primary w-100" download>
              <i class="bi bi-download me-2"></i>
              دانلود نُت
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
 {% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js"></script>
<script>
  PDFObject.embed("{{note.notesheet.url}}", "#pdf-viewer", {
    width: "100%",
    height: "800px",
  });
</script>

{% endblock %}
