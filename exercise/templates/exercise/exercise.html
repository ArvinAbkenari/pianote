{% extends 'base.html' %}
{% load static %}
{% block title %}تمرین - پیانوت{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'exercise/exercise.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container dashboard-content">
    <h1 class="exercise_title mb-4">داشبورد تمرین</h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
    <input type="hidden" name="selected_exercise" id="selectedExerciseInput" value="{{ selected_exercise|default:'' }}">

        <section class="song-selection-section">
            <h2>تمرین خود را انتخاب کنید</h2>
            <div class="song-library">
                {% for exercise in exercises %}
                <div class="song-card" data-exercise-id="{{ exercise.id }}">
                    <div class="song-info">
                        <h3>{{ exercise.title }}</h3>
                        <p>{{ exercise.metrics|length }} رکورد</p>
                    </div>
                    <button type="button" class="select-btn">انتخاب</button>
                </div>
                {% endfor %}
                <div class="upload-card" id="referenceUploadCard" style="cursor:pointer;">
                    <i class="bi bi-plus-circle-dotted"></i>
                    <p>ثبت تمرین جدید</p>
                </div>
            </div>
        </section>

    <!-- Practice Section (hidden until an exercise is selected) -->
    <section id="practiceSection" class="practice-section" style="display:none;">
            <h2>فایل های شما</h2>
            <div class="upload-container" style="display:flex;gap:20px;flex-wrap:wrap;">
                
                <!-- Reference Upload -->
                <div class="upload-box" id="refUpload" style="flex:1;position:relative;display:none;">
                    <i class="bi bi-mic-fill"></i>
                    <p>بارگذاری قطعه مرجع</p>
                    <span>یا فایل صوتی را بکشید و رها کنید</span>
                    {{ audio_form.reference_audio }}
                    <div class="uploaded-filename" id="referenceFileName"></div>
                </div>

                <!-- User Upload -->
                <div class="upload-box" id="practiceUpload" style="flex:1;position:relative;display:none;">
                    <i class="bi bi-mic-fill"></i>
                    <p>بارگذاری ضبط تمرین شما</p>
                    <span>یا فایل صوتی را بکشید و رها کنید</span>
                    {{ audio_form.user_audio }}
                    <div class="uploaded-filename" id="userFileName"></div>
                </div>
            </div>

            <div class="visualization-container">
                <div class="waveform-comparison">
                    <div class="waveform original">
                        <h4>اصلی</h4>
                        <audio id="refAudioWave" controls style="width:100%;margin-top:10px;display:none;">
                            مرورگر شما از این عنصر پشتیبانی نمی‌کند.
                        </audio>
                    </div>
                    <div class="waveform practice">
                        <h4>تمرین شما</h4>
                        <audio id="userAudioWave" controls style="width:100%;margin-top:10px;display:none;"></audio>
                    </div>
                </div>
            </div>
        </section>

    <button id="analyzeBtn" type="submit" class="btn btn-primary mb-5 w-100 p-3" style="font-size: 20px;display:none;">تحلیل کن</button>

    <!-- Performance Metrics (hidden until analysis result) -->
    <section id="performanceMetrics" class="performance-metrics" style="display:none;">
            <h2>تحلیل عملکرد</h2>
            <div class="metrics-grid">
                <div class="metric-card overall-score">
                    <div class="metric-header">
                        <i class="bi bi-star-fill"></i>
                        <h3>امتیاز کلی</h3>
                    </div>
                    <div class="score"><span id="overallScoreValue">{{ result.overall_score|default:'0' }}</span><span class="percentage">%</span></div>
                </div>
                <div class="metric-cards-container">
                    <div class="metric-card">
                        <div class="metric-header">
                            <i class="bi bi-music-note"></i>
                            <h3>دقت نت‌ها</h3>
                        </div>
                        <div class="score"><span id="pitchScoreValue">{{ result.pitch_score|default:'0' }}</span><span class="percentage">%</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <i class="bi bi-clock"></i>
                            <h3>دقت زمان‌بندی</h3>
                        </div>
                        <div class="score"><span id="tempoScoreValue">{{ result.tempo_diff_percentage|default:'0' }}</span><span class="percentage">%</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <i class="bi bi-volume-up"></i>
                            <h3>دقت صدا</h3>
                        </div>
                        <div class="score"><span id="energyScoreValue">{{ result.energy_score|default:'0' }}</span><span class="percentage">%</span></div>
                    </div>
                </div>
            </div>
        </section>

        {% if result.error %}
        <div class="error-message">
            <i class="bi bi-exclamation-triangle"></i>
            <span>خطا: {{ result.error }}</span>
        </div>
        {% endif %}
        <!-- Chart moved below everything -->
        <div id="metricsArea" style="margin-top:20px;display:none;">
            <canvas id="metricsChart" style="width:100%;height:320px;"></canvas>
        </div>
    </form>
</div>
    <!-- Modal Backdrop -->
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <!-- Modal -->
    <div class="modal-custom" id="exerciseModal">
        <span class="modal-close" id="modalClose">&times;</span>
        <h2 class="modal-title mb-3">ایجاد تمرین جدید</h2>
        <form method="post" action="{% url 'exercise_create' %}">
            {% csrf_token %}
            <div class="form-group mb-3">
                {{ create_form.title.label_tag }}
                {{ create_form.title }}
                {{ create_form.title.errors }}
            </div>
            <button type="submit" class="btn btn-success w-100">ایجاد تمرین</button>
        </form>
    </div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'exercise/exercise.js' %}"></script>
{% if result %}
  {{ result|json_script:"chartjsResultData" }}
{% endif %}

<script>
    const referenceUploadCard = document.getElementById('referenceUploadCard');
    const modal = document.getElementById('exerciseModal');
    const backdrop = document.getElementById('modalBackdrop');
    const closeBtn = document.getElementById('modalClose');

    if(referenceUploadCard && modal && backdrop && closeBtn) {
        function showModal() {
            backdrop.style.display = 'block';
            modal.style.display = 'block';
            // Trigger reflow
            modal.offsetHeight;
            modal.classList.add('show');
            setTimeout(() => {
                const input = modal.querySelector('input[name="title"]');
                if(input) input.focus();
            }, 100);
        }

        function hideModal() {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                backdrop.style.display = 'none';
            }, 300); // Match the transition time
        }

        referenceUploadCard.onclick = showModal;
        closeBtn.onclick = hideModal;
        backdrop.onclick = hideModal;
    }
</script>
{% endblock %}
