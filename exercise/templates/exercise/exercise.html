{% extends 'base.html' %}
{% load static %}
{% block title %}تمرین - پیانوت{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'exercise/exercise.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container dashboard-content ">
    <h1 class=" exercise_title mb-4">داشبورد تمرین</h1>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <section class="song-selection-section">
            <h2>قطعه خود را انتخاب کنید</h2>
            <div class="song-library">
                {% for ref in reference_files %}
                <div class="song-card" data-ref="{{ ref }}">
                    <div class="song-info">
                        <h3>
                          {% if ref|length > 15 %}
                            {{ ref|slice:":15" }}...
                          {% else %}
                            {{ ref }}
                          {% endif %}
                        </h3>
                        <p>فایل مرجع</p>
                    </div>
                    <button type="button" class="select-btn">انتخاب</button>
                </div>
                {% endfor %}
                <div class="upload-card" id="referenceUploadCard">
                    <i class="bi bi-plus-circle-dotted"></i>
                    <p>بارگذاری قطعه جدید</p>
                    {{ audio_form.reference_audio }}
                </div>
            </div>
            <input type="hidden" name="selected_reference" id="selectedReferenceInput">
        </section>

        <section class="practice-section">
            <h2>تمرین شما</h2>
            <div class="upload-container">
                <div class="upload-box" id="practiceUpload">
                    <i class="bi bi-mic-fill"></i>
                    <p>بارگذاری ضبط تمرین شما</p>
                    <span>یا فایل صوتی را بکشید و رها کنید</span>
                    {{ audio_form.user_audio }}
                    <div class="uploaded-filename" id="userFileName"></div>
                </div>
            </div>

            <div class="visualization-container">
                <div class="waveform-comparison">
                    <div class="waveform original">
                        <h4>اصلی</h4>

                        <audio id="referenceAudioPlayer" controls style="width:100%;margin-top:10px;">
                          {% if selected_reference %}
                            <source src="{{ MEDIA_URL }}reference_audio/{{ selected_reference }}" type="audio/mpeg">
                          {% endif %}
                          Your browser does not support the audio element.
                        </audio>
                    </div>
                    <div class="waveform practice">
                        <h4>تمرین شما</h4>
                        <audio id="userAudioPlayer" controls style="width:100%;margin-top:10px;"></audio>
                    </div>
                </div>
            </div>
        </section>
                <button type="submit" class="btn btn-primary mb-5 w-100 p-3"style="font-size: 20px;" >تحلیل کن</button>

        <section class="performance-metrics">
            <h2>تحلیل عملکرد</h2>
            <div class="metrics-grid">
                <div class="metric-card overall-score">
                    <div class="metric-header">
                        <i class="bi bi-star-fill"></i>
                        <h3>امتیاز کلی</h3>
                    </div>
                    <div class="score">{{ result.overall_score|default:'0' }}<span class="percentage">%</span></div>
                </div>
                <div class="metric-cards-container">
                    <div class="metric-card">
                        <div class="metric-header">
                            <i class="bi bi-music-note"></i>
                            <h3>دقت نت‌ها</h3>
                        </div>
                        <div class="score">{{ result.pitch_score|default:'0' }}<span class="percentage">%</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <i class="bi bi-clock"></i>
                            <h3>دقت زمان‌بندی</h3>
                        </div>
                        <div class="score">{{ result.tempo_diff_percentage|default:'0' }}<span class="percentage">%</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <i class="bi bi-volume-up"></i>
                            <h3>دقت صدا</h3>
                        </div>
                        <div class="score">{{ result.energy_score|default:'0' }}<span class="percentage">%</span></div>
                    </div>
                </div>
            </div>
        </section>
        {% if result.error %}
            <div class="error-message">
                <i class="bi bi-exclamation-triangle"></i>
                <span>خطا: {{ result.error }}</span>
            </div>
        {% endif %}
    </form>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static "exercise/exercise.js"%}"></script>
{% if result %}
  {{ result|json_script:"chartjsResultData" }}
{% endif %}
{% endblock %}
